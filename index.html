<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hourly Case Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  padding: 20px;
}
input, button {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
}
button { background: #2563eb; color: white; border: none; }
button.reset { background: #dc2626; }
.card {
  background: #020617;
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 15px;
}
.log-entry { margin-bottom: 6px; }
small { color: #94a3b8; }
</style>
</head>

<body>

<h1>Hourly Case Tracker</h1>

<div class="card">
  <input id="date" placeholder="Date">
  <input id="material" placeholder="Material Code">
  <input id="startCount" type="number" placeholder="Starting Count">
  <button onclick="setDaily()">Set Day</button>
</div>

<div class="card">
  <input id="time" placeholder="Time">
  <input id="count" type="number" placeholder="Current Count">
  <button onclick="addEntry()">Add Entry</button>
</div>

<div class="card">
  <div id="summary"><small>No data yet</small></div>
  <div id="log"></div>
</div>

<button class="reset" onclick="resetDay()">Reset Day</button>

<script>
const REPO = "Brandonmcgirl/Case-tracker";
const WORKFLOW = "update-log.yml";
const WRITE_KEY = prompt("Enter write password");

let date="", material="", lastCount=null;

async function loadLog() {
  const res = await fetch("log.json?" + Date.now());
  const data = await res.json();
  const log = document.getElementById("log");
  log.innerHTML = "";

  data.forEach(e => {
    log.innerHTML += `<div class="log-entry">${e.time} | ${e.material} | ${e.count} (+${e.diff})</div>`;
  });

  if (data.length) {
    const last = data[data.length - 1];
    lastCount = last.count;
    date = last.date;
    material = last.material;
    document.getElementById("summary").innerHTML =
      `<b>${date}</b><br>${material}<br>Last: ${lastCount}`;
  }
}

function setDaily() {
  date = document.getElementById("date").value || new Date().toDateString();
  material = document.getElementById("material").value;
  lastCount = parseInt(document.getElementById("startCount").value);
}

async function dispatch(entry, reset=false) {
  await fetch(`https://api.github.com/repos/${REPO}/actions/workflows/${WORKFLOW}/dispatches`, {
    method: "POST",
    headers: { "Accept": "application/vnd.github.v3+json" },
    body: JSON.stringify({
      ref: "main",
      inputs: {
        key: WRITE_KEY,
        new_entry: JSON.stringify(entry),
        reset: reset ? "true" : "false"
      }
    })
  });
}

async function addEntry() {
  const time = document.getElementById("time").value;
  const count = parseInt(document.getElementById("count").value);
  if (!time || isNaN(count)) return;

  const diff = count - lastCount;
  lastCount = count;

  await dispatch({ date, time, material, count, diff });
  setTimeout(loadLog, 4000);
}

async function resetDay() {
  await dispatch({}, true);
  lastCount=null;
  setTimeout(loadLog, 4000);
}

setInterval(loadLog, 20000);
loadLog();
</script>
</body>
</html>