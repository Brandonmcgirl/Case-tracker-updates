<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hourly Case Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* { box-sizing: border-box; }

body {
    font-family: Arial;
    background: #0f172a;
    color: #e5e7eb;
    padding: 20px;
}

input, button, select {
    width: 100%;
    padding: 10px;
    margin: 6px 0;
    font-size: 16px;
}

button {
    background: #2563eb;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}

button.reset { background: #dc2626; }

.card {
    background: #020617;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
}

.log {
    border-top: 1px solid #334155;
    margin-top: 10px;
    padding-top: 10px;
}

.log-entry { margin-bottom: 6px; }

small { color: #94a3b8; }
</style>
</head>

<body>

<h1>Hourly Case Tracker</h1>

<div class="card">
    <h3>Line Selection</h3>
    <select id="lineSelect" onchange="lineChanged()">
        <option value="">-- Select Line --</option>
    </select>

    <input id="newLine" placeholder="New Line Name / Number">
    <button onclick="addLine()">Add Line</button>
    <button onclick="deleteLine()" class="reset">Delete Line</button>
</div>

<div class="card">
    <h3>Run Setup</h3>
    <input id="material" placeholder="Material Code">
    <input id="startCount" type="number" placeholder="Starting Case Count">
    <button onclick="startRun()">Start Run</button>
</div>

<div class="card">
    <h3>Hourly Entry</h3>
    <input id="time" placeholder="Time (7am, 7:30)">
    <input id="count" type="number" placeholder="Current Case Count">
    <button onclick="addEntry()">Add Entry</button>
</div>

<div class="card">
    <h3>Log</h3>
    <div id="liveTime"><small></small></div>
    <div id="summary"><small>Waiting for run...</small></div>
    <div id="log" class="log"></div>
</div>

<div class="card">
    <h3>Last Run Info</h3>
    <div id="lastRun"><small>No previous run</small></div>
</div>

<button class="reset" onclick="endRun()">End Of Run</button>

<script>

/* ===== STATE ===== */

let lines = [];
let currentLine = "";
let lastCount = null;
let material = "";
let runStartTime = null;
let lastRun = {}; // per line

const SERVER_URL = "https://cases.hytalesanarchy.com";

/* ===== DOM ===== */

const lineSelect = document.getElementById("lineSelect");
const materialInput = document.getElementById("material");
const startCountInput = document.getElementById("startCount");
const timeInput = document.getElementById("time");
const countInput = document.getElementById("count");

/* ===== LIVE CLOCK ===== */

function updateClock() {
    const now = new Date();
    document.getElementById("liveTime").innerHTML =
        `<small>${now.toDateString()} (${now.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'})})</small>`;
}

setInterval(updateClock, 60000);
updateClock();

/* ===== PASSWORD PROMPT ===== */

async function getPassword(promptMsg = "Enter password:") {
    const pw = prompt(promptMsg);
    if (!pw) throw new Error("Password required");
    return pw;
}

/* ===== SERVER COMMUNICATION ===== */

async function sendToServer(entry = {}, reset = false, line = "", action = "add", requirePassword = true) {

    if (!line) {
        alert("No line selected!");
        return { error: "No line selected" };
    }

    let password = "";

    if (requirePassword) {
        try {
            password = await getPassword();
        } catch {
            alert("Password is required for this action.");
            return { error: "Password required" };
        }
    }

    try {
        const res = await fetch(`${SERVER_URL}/add`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ entry, reset, line, action, password })
        });

        if (res.status === 403) {
            alert("Wrong password!");
            return { error: "Forbidden" };
        }

        const data = await res.json();
        await loadLog();
        return data;

    } catch {
        alert("Server unreachable");
        return { error: "Server unreachable" };
    }
}

/* ===== LOAD LOG ===== */

async function loadLog() {
    try {
        const res = await fetch(`${SERVER_URL}/log.json?${Date.now()}`);
        const data = await res.json();

        populateLines(data);
        displayLog(data);
        updateLastRunInfo(data);

        if (currentLine) {
            const activeStart = data.find(e => e.line === currentLine && e.time === "Start");
            if (activeStart) {
                lastCount = activeStart.count;
                material = activeStart.material;
                updateSummary();
            }
        }

    } catch {
        document.getElementById("log").innerHTML =
            "<small>Server not reachable.</small>";
    }
}

/* ===== LINES ===== */

function populateLines(data) {
    lines = [...new Set(data.map(e => e.line))].filter(Boolean);

    const old = lineSelect.value;
    lineSelect.innerHTML = '<option value="">-- Select Line --</option>';

    lines.forEach(l => {
        const o = document.createElement("option");
        o.value = l;
        o.text = l;
        lineSelect.appendChild(o);
    });

    if (lines.includes(old)) {
        lineSelect.value = old;
        currentLine = old;
    }
}

function lineChanged() {
    currentLine = lineSelect.value;
    lastCount = null;
    material = "";
    runStartTime = null;
    updateSummary();
    displayLog([]);
    updateLastRunInfo();
}

/* ===== SUMMARY ===== */

function updateSummary() {
    const summary = document.getElementById("summary");

    if (currentLine && lastCount !== null) {
        summary.innerHTML =
            `<b>Material:</b> ${material}<br><b>Last Count:</b> ${lastCount}`;
    } else {
        summary.innerHTML = "<small>Waiting for run...</small>";
    }
}

/* ===== INIT ===== */

loadLog();
setInterval(loadLog, 5000);

</script>

</body>
</html>
